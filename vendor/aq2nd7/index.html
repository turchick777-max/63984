<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<title>HOW IT WORKS - AQUINTAQA</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #F4F7FA;
  --grid-minor: rgba(15, 23, 42, 0.055);
  --grid-major: rgba(15, 23, 42, 0.085);
  --frame: rgba(15, 23, 42, 0.18);
  --frame2: rgba(15, 23, 42, 0.12);
  --accent: #009EBA;
  --core-fill: #D4F1F6;
  --cots-fill: #FFFFFF;
  --cots-stroke: rgba(15,23,42,0.22);
  --stream: rgba(71,85,105,0.65);
  --stream-dash: rgba(71,85,105,0.45);
  --conc: #D28437;
  --conc-fill: #FCF0E5;
  --shadow: 0 12px 40px rgba(15,23,42,0.06);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  -webkit-font-smoothing: antialiased;
}

.hiw {
  padding: 10px 10px 20px 10px;
  position: relative;
  background:
    /* Minor grid lines (32px) */
    linear-gradient(var(--grid-minor) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-minor) 1px, transparent 1px),
    /* Major grid lines (160px) */
    linear-gradient(var(--grid-major) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-major) 1px, transparent 1px),
    /* Minor grid dots at intersections (32px) */
    radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.15) 0, rgba(15, 23, 42, 0.15) 1px, rgba(15, 23, 42, 0.08) 1.5px, transparent 2px),
    /* Major grid dots at intersections (160px) */
    radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.18) 0, rgba(15, 23, 42, 0.18) 1.5px, rgba(15, 23, 42, 0.08) 2px, transparent 2.5px);
  background-color: var(--bg);
  background-size: 32px 32px, 32px 32px, 160px 160px, 160px 160px, 32px 32px, 160px 160px;
  background-position: 0 0, 0 0, 0 0, 0 0, 0 0, 0 0;
}

.hiw::before {
  content: '';
  position: absolute;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(15, 23, 42, 0.12) 1.5px, transparent 1.5px);
  background-size: 12px 12px;
  pointer-events: none;
  z-index: 0;
  top: 0;
  left: 0;
  mask-image: radial-gradient(ellipse 120% 120% at top left, black 0%, transparent 70%);
  -webkit-mask-image: radial-gradient(ellipse 120% 120% at top left, black 0%, transparent 70%);
}

.hiw__sheet {
  position: relative;
  margin: 0 auto;
  max-width: 1400px;
  padding: 10px;
}


.hiw__frame {
  position: absolute;
  inset: 0;
  border: 1px solid var(--frame2);
  pointer-events: none;
}

.hiw__corner { position: absolute; width: 12px; height: 12px; }
.hiw__corner.tl { top: -3px; left: -3px; border-left: 3px solid rgba(15, 23, 42, 0.35); border-top: 3px solid rgba(15, 23, 42, 0.35); }
.hiw__corner.tr { top: -3px; right: -3px; border-right: 3px solid rgba(15, 23, 42, 0.35); border-top: 3px solid rgba(15, 23, 42, 0.35); }
.hiw__corner.bl { bottom: -3px; left: -3px; border-left: 3px solid rgba(15, 23, 42, 0.35); border-bottom: 3px solid rgba(15, 23, 42, 0.35); }
.hiw__corner.br { bottom: -3px; right: -3px; border-right: 3px solid rgba(15, 23, 42, 0.35); border-bottom: 3px solid rgba(15, 23, 42, 0.35); }

.hiw__header {
  padding: 28px 20px 18px;
  text-align: center;
}

.hiw__title {
  font: 600 42px/1.1 ui-sans-serif, system-ui;
  letter-spacing: 0.28em;
  color: rgba(15,23,42,.72);
}

/* Main layout: sidebar left + diagram right */
.hiw__main {
  display: flex;
  gap: 15px;
  align-items: flex-start; /* Sidebar ends at its content height */
  margin-bottom: 0;
}

/* Left sidebar */
.hiw__left-sidebar {
  width: 280px;
  flex-shrink: 0;
  padding: 15px 10px;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(15,23,42,0.1);
  border-bottom: 1px solid rgba(15,23,42,0.1);
  border-radius: 0;
  height: auto;
  display: flex;
  flex-direction: column;
}

/* Diagram area container */
.hiw__diagram-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
}

.hiw__stage-nav {
  display: flex;
  flex-direction: column;
  gap: 14px;
  position: relative;
  margin-top: 70px;
}

.hiw__stage-nav::before {
  content: '';
  position: absolute;
  left: 17.5px;
  top: 28px;
  bottom: 28px;
  width: 1px;
  background: rgba(100,116,139,0.25);
  z-index: 0;
}

.hiw__stage-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: transparent;
  border: none;
  cursor: pointer;
  text-align: left;
  transition: color 0.2s;
  position: relative;
}

.hiw__stage-btn:hover {
  opacity: 0.8;
}

.hiw__stage-btn.is-active .hiw__stage-dot {
  border-color: var(--accent);
  background: var(--accent);
}

.hiw__stage-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--bg);
  border: 2px solid rgba(100,116,139,0.4);
  flex-shrink: 0;
  transition: border-color 0.2s;
  position: relative;
  z-index: 2;
}

.hiw__stage-name {
  font: 600 16px/1.4 ui-sans-serif, system-ui;
  color: rgba(15,23,42,0.65);
  text-transform: uppercase;
  letter-spacing: 0.02em;
  transition: color 0.2s;
}

.hiw__stage-btn.is-active .hiw__stage-name {
  color: var(--accent);
}

/* Diagram area */
.hiw__diagram-wrapper {
  position: relative;
  background: transparent;
  border: none;
  border-radius: 0;
  padding: 0;
  margin-bottom: 0;
  min-height: 580px;
}

.hiw__svg {
  width: 100%;
  height: auto;
  display: block;
}

/* Interactive panel — "Г" shape: title narrow on top-left, body full-width below */
.hiw__panel {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0;
  margin-top: -230px;
  position: relative;
  z-index: 3;
  background: transparent; 
  border: none;
}

.hiw__panel-header {
  width: 280px;
  flex-shrink: 0;
  min-height: 160px;
  padding: 12px 16px;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(15,23,42,0.1);
  border-bottom: none;
  
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

.hiw__panel-header::after { display: none; }

.hiw__panel-body {
  align-self: stretch;
  margin-right: 330px;
  padding: 14px 24px;
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(15,23,42,0.1);
  border-top: none;
  
  display: flex;
  align-items: center;
}

.hiw__panel-body::before { display: none; }

.hiw__detail-kicker {
  font: 700 10px ui-monospace, monospace;
  letter-spacing: 0.12em;
  color: rgba(71,85,105,0.7);
  text-transform: uppercase;
  margin-bottom: 6px;
  display: none;
}

.hiw__detail-title {
  font: 700 18px/1.2 ui-sans-serif, system-ui;
  color: rgba(15, 23, 42, 0.88);
  letter-spacing: 0.04em;
  text-transform: uppercase;
  margin: 0;
}

.hiw__detail-text {
  font: 400 14px/1.65 ui-sans-serif, system-ui;
  color: rgba(51,65,85,0.9);
}

/* Legend (HTML version) */
.hiw__legend {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 15px 0;
}

.hiw__legend-title {
  font: 700 10px ui-sans-serif, system-ui;
  letter-spacing: 0.08em;
  color: rgba(15,23,42,0.7);
  text-transform: uppercase;
  margin-bottom: 4px;
}

.hiw__legend-items {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.hiw__legend-item {
  display: flex;
  align-items: center;
  gap: 10px;
}

.hiw__legend-swatch {
  width: 16px;
  height: 16px;
  border-radius: 0;
  border: 1.5px solid;
  flex-shrink: 0;
}

.hiw__legend-swatch.core {
  background: var(--core-fill);
  border-color: rgba(0,158,186,0.7);
}

.hiw__legend-swatch.cots {
  background: #fff;
  border-color: rgba(186,198,211,0.8);
}

.hiw__legend-label {
  font: 400 11px/1.35 ui-sans-serif, system-ui;
  color: rgba(15,23,42,0.75);
}

.hiw__legend-note {
  font: 400 10px/1.5 ui-sans-serif, system-ui;
  color: rgba(210,132,55,0.9);
  margin-top: 4px;
}

.hiw__legend-note-secondary {
  font: 500 10px/1.5 ui-sans-serif, system-ui;
  color: rgba(15,23,42,0.65);
}

/* SVG Styles */
.svgLabel { font: 500 12px 'Space Mono', 'IBM Plex Mono', 'Courier New', monospace; fill: rgba(15,23,42,.7); }
.svgSubLabel { font: 400 10px 'Space Mono', 'IBM Plex Mono', 'Courier New', monospace; fill: rgba(15,23,42,.7); }
.svgCalloutBox { fill: none; stroke: none; }
.svgCalloutText { font: 500 10px 'Space Mono', 'IBM Plex Mono', 'Courier New', monospace; fill: rgba(15,23,42,.7); }
.moduleBox { stroke-width: 1; filter: none; }
.module .moduleTitle { font: 600 13px 'Space Mono', 'IBM Plex Mono', 'Courier New', monospace; fill: rgba(15,23,42,.88); }
.module .moduleSub { font: 400 10px 'Space Mono', 'IBM Plex Mono', 'Courier New', monospace; fill: rgba(15,23,42,.88); }
.module.core .moduleBox { fill: var(--core-fill); stroke: rgba(0,158,186,.5); }
.module.cots .moduleBox { fill: var(--cots-fill); stroke: rgba(15,23,42,0.18); }
.module.concentrate .moduleBox { fill: var(--conc-fill); stroke: rgba(210,132,55,.5); }
.module.concentrate .moduleTitle { fill: rgba(180,100,30,.9); }
.module.concentrate .moduleSub { fill: rgba(180,100,30,.65); }
.stream { fill: none; stroke: var(--stream); stroke-width: 1; stroke-dasharray: 4 3; }
.stream.accent { stroke: var(--stream); stroke-width: 1; stroke-dasharray: 4 3; }
.stream.concentrate { stroke: rgba(210,132,55,.6); stroke-width: 1; stroke-dasharray: 4 3; }
.coreBoundary { fill: none; stroke: rgba(0,158,186,.45); stroke-width: 1; stroke-dasharray: 6 4; }
.module.is-active .moduleBox { stroke-width: 1.5; stroke: var(--accent); filter: drop-shadow(0 0 6px rgba(0,158,186,0.2)); }

/* Force desktop view on all devices - viewport only, no scroll */
html, body {
  overflow-x: hidden !important;
}

/* ── MOBILE ONLY  ≤ 767px ── */
@media (max-width: 767px) {

  html, body {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }
  body { overflow-y: hidden !important; }

  .hiw { padding: 0; contain: layout paint; }

  .hiw__sheet { padding: 8px 8px 0; }

  .hiw__header { padding: 10px 12px 6px; }
  .hiw__title  { font-size: 14px; letter-spacing: 0.2em; }

  /* ── MAIN: vertical stack ── */
  .hiw__main {
    flex-direction: column;
    gap: 0;
    margin-bottom: 0;
  }

  /* ── STAGE CHIPS: horizontal scroll row ── */
  .hiw__left-sidebar {
    width: 100%;
    max-width: 100%;
    height: auto !important;
    padding: 0;
    background: transparent;
    border: none;
    overflow: hidden;            /* prevent sidebar itself from expanding */
  }

  .hiw__stage-nav {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;           /* single row, always */
    gap: 6px;
    margin-top: 0;
    padding: 4px 8px 10px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    max-width: 100%;
  }
  .hiw__stage-nav::-webkit-scrollbar { display: none; }
  .hiw__stage-nav::before { display: none; }

  .hiw__stage-btn {
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;              /* chips never shrink */
    gap: 4px;
    padding: 10px 14px;
    min-height: 44px;            /* Apple HIG: 44 px tap target */
    min-width: 80px;
    background: rgba(255,255,255,0.72);
    border: 1px solid rgba(15,23,42,0.1);
    border-radius: 2px;
    text-align: center;
    transition: background 0.18s, border-color 0.18s;
  }
  .hiw__stage-btn.is-active {
    background: rgba(0,158,186,0.10);
    border-color: rgba(0,158,186,0.5);
  }
  .hiw__stage-dot { display: none !important; }
  .hiw__stage-name {
    font-size: 9.5px;
    line-height: 1.3;
    color: rgba(15,23,42,0.65);
    white-space: normal;         /* allow <br> inside chip */
  }
  .hiw__stage-btn.is-active .hiw__stage-name { color: var(--accent); }

  /* ── DIAGRAM AREA ── */
  .hiw__diagram-area  { position: relative; }
  .hiw__diagram-wrapper {
    padding: 0 !important;
    min-height: 0 !important;
    background: transparent;
    border: none;
    margin-bottom: 0;
    overflow: visible;
  }

  /* pan-zoom viewport – injected by JS */
  .hiw-mobile-vp {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    height: 300px;               /* comfortable on 390px iPhone */
    max-height: 52vh;            /* never taller than 52 % of iframe vp */
    overflow: hidden;
    touch-action: none;
    position: relative;
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(15,23,42,0.1);
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    contain: layout paint;
  }
  .hiw-mobile-vp.is-grabbing { cursor: grabbing; }

  .hiw-mobile-inner {
    transform-origin: 0 0;
    will-change: transform;
    position: absolute;
    top: 0; left: 0;
  }

  /* SVG fixed size so scale math works */
  .hiw-mobile-inner .hiw__svg {
    width: 900px !important;
    height: 620px !important;
    display: block !important;
    max-width: none !important;  /* override the global max-width:100% rule */
  }

  /* zoom +/- buttons — 44 × 44 px tap target */
  .hiw-zoom-bar {
    position: absolute;
    top: 8px; right: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 20;
  }
  .hiw-zoom-btn {
    width: 44px; height: 44px;  /* Apple HIG minimum */
    background: rgba(255,255,255,0.93);
    border: 1px solid rgba(15,23,42,0.12);
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 300;
    line-height: 1;
    color: rgba(15,23,42,0.6);
    cursor: pointer;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    box-shadow: 0 1px 4px rgba(15,23,42,0.08);
  }

  .hiw-mobile-hint { display: none !important; }

  /* ── DETAIL PANEL (mobile) ── */
  .hiw__panel {
    flex-direction: column;
    background: rgba(255,255,255,0.5) !important;
    border: 1px solid rgba(15,23,42,0.1) !important;
  }
  .hiw__panel-header {
    width: 100% !important;
    padding: 10px 12px 4px !important;
    background: transparent !important;
    border: none !important;
    border-bottom: 1px solid rgba(15,23,42,0.06) !important;
  }
  .hiw__panel-body {
    padding: 8px 12px !important;
    padding-bottom: max(16px, env(safe-area-inset-bottom)) !important;
    background: transparent !important;
    border: none !important;
    margin-right: 0 !important;
  }
  .hiw__detail-kicker { display: block !important; margin-bottom: 3px; }
  .hiw__detail-title  { font-size: 14px; margin: 0 0 5px; }
  .hiw__detail-text   { font-size: 12.5px; line-height: 1.55; }
}

/* ── iPhone SE / small phones ≤ 375px ── */
@media (max-width: 375px) {
  .hiw-mobile-vp { height: 260px; }
  .hiw__stage-btn { padding: 9px 10px; min-width: 70px; }
  .hiw__stage-name { font-size: 9px; }
}

/* ── Lang switcher in header ── */
.hiw__header { position: relative; }
.lang-switch-hiw {
  position: absolute;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 2px;
  align-items: center;
}
.lang-btn-hiw {
  background: none;
  border: none;
  color: rgba(15,23,42,0.35);
  padding: 4px 9px;
  cursor: pointer;
  font: 500 11px ui-sans-serif, system-ui;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  transition: color 0.18s;
  line-height: 1;
}
.lang-btn-hiw.active { color: var(--accent); }
.lang-btn-hiw:hover  { color: var(--accent); }
.lang-sep-hiw {
  color: rgba(15,23,42,0.18);
  font-size: 10px;
  line-height: 1;
  pointer-events: none;
  user-select: none;
}
@media (max-width: 767px) {
  .lang-switch-hiw { right: 8px; }
  .lang-btn-hiw { padding: 4px 6px; font-size: 9.5px; }
}

/* ── TABLET  768–1024px ── */
@media (min-width: 768px) and (max-width: 1024px) {
  html, body { overflow-x: hidden !important; }

  .hiw__sheet { max-width: 100%; padding: 10px 16px; }

  /* Sidebar a bit narrower on tablet */
  .hiw__left-sidebar { width: 220px; }

  .hiw__stage-name { font-size: 13px; }

  /* Diagram stays flexible */
  .hiw__diagram-wrapper { min-height: 420px; }
}
</style>
</head>
<body>

<section class="hiw" id="how-it-works">
  <div class="hiw__sheet">
    <div class="hiw__frame" aria-hidden="true">
      <span class="hiw__corner tl"></span>
      <span class="hiw__corner tr"></span>
      <span class="hiw__corner bl"></span>
      <span class="hiw__corner br"></span>
    </div>

    <header class="hiw__header">
      <h2 class="hiw__title">HOW IT WORKS</h2>
      <div class="lang-switch-hiw">
        <button class="lang-btn-hiw active" data-lang="en" onclick="window.setLang('en')">EN</button>
        <span class="lang-sep-hiw">|</span>
        <button class="lang-btn-hiw" data-lang="ru" onclick="window.setLang('ru')">RU</button>
      </div>
    </header>

    <!-- Main: Left sidebar + Diagram -->
    <div class="hiw__main">
      <!-- Left sidebar with stages -->
      <aside class="hiw__left-sidebar">
        <nav class="hiw__stage-nav">
          <button class="hiw__stage-btn is-active" data-stage="0">
            <span class="hiw__stage-dot"></span>
            <span class="hiw__stage-name">Intake<br>&amp;&nbsp;Stabilization</span>
          </button>
          <button class="hiw__stage-btn" data-stage="1">
            <span class="hiw__stage-dot"></span>
            <span class="hiw__stage-name">Gas-Sorbent</span>
          </button>
          <button class="hiw__stage-btn" data-stage="2">
            <span class="hiw__stage-dot"></span>
            <span class="hiw__stage-name">Sorption</span>
          </button>
          <button class="hiw__stage-btn" data-stage="3">
            <span class="hiw__stage-dot"></span>
            <span class="hiw__stage-name">Separation</span>
          </button>
          <button class="hiw__stage-btn" data-stage="4">
            <span class="hiw__stage-dot"></span>
            <span class="hiw__stage-name">Mineralization<br>& Polishing</span>
          </button>
        </nav>
      </aside>

      <!-- Diagram area -->
      <div class="hiw__diagram-area">
        <div class="hiw__diagram-wrapper">
          <svg class="hiw__svg" viewBox="-60 0 900 620" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
            <defs>
              <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--stream)" />
              </marker>
              <marker id="arrowAccent" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--stream)" />
              </marker>
              <marker id="arrowConc" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="5" markerHeight="5" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(210,132,55,.6)" />
              </marker>
            </defs>

            <!-- L-shaped panel frame: main rect + bottom-right extension for Drinking Water -->
            <path d="M -58 1 L 838 1 L 838 618 L 640 618 L 640 540 L -58 540 Z"
                  fill="rgba(255,255,255,0.5)"
                  stroke="rgba(15,23,42,0.12)"
                  stroke-width="1"/>
            <!-- Inner-corner accent mark at step -->
            <line x1="640" y1="535" x2="640" y2="545" stroke="rgba(15,23,42,0.25)" stroke-width="2"/>
            <line x1="635" y1="540" x2="645" y2="540" stroke="rgba(15,23,42,0.25)" stroke-width="2"/>

            <!-- Feed Water label (top left) -->
            <text id="svgT-feed1" x="60" y="35" text-anchor="middle" class="svgLabel">Feed water</text>
            <text id="svgT-feed2" x="60" y="49" text-anchor="middle" class="svgSubLabel">(seawater / brackish /</text>
            <text id="svgT-feed3" x="60" y="61" text-anchor="middle" class="svgSubLabel">high-salinity / variable)</text>

            <!-- Line from feed water down to INTAKE -->
            <path d="M 60 70 L 60 150 L 120 150" class="stream" marker-end="url(#arrow)"/>

            <!-- INTAKE (left side, top row) -->
            <g id="m-intake" class="module cots">
              <rect x="120" y="120" width="140" height="60" rx="0" class="moduleBox"/>
              <text id="svgT-intake1" x="190" y="145" text-anchor="middle" class="moduleTitle">Intake</text>
              <text id="svgT-intake2" x="190" y="163" text-anchor="middle" class="moduleTitle">& Stabilization</text>
            </g>

            <!-- Inert gas label (top center-right) -->
            <g class="svgCallout">
              <rect x="430" y="90" width="110" height="36" rx="0" class="svgCalloutBox"/>
              <text id="svgT-gas1" x="485" y="106" text-anchor="middle" class="svgCalloutText" style="fill:#009EBA;">Inert carrier gas</text>
              <text id="svgT-gas2" x="485" y="118" text-anchor="middle" class="svgCalloutText" style="fill:#009EBA;">+ proprietary sorbent</text>
            </g>

            <!-- Vertical line from Inert carrier down to Gas-Sorbent -->
            <path d="M 485 126 L 485 160" class="stream" marker-end="url(#arrow)"/>

            <!-- GAS-SORBENT (center, top row) -->
            <g id="m-dosing" class="module core">
              <rect x="410" y="160" width="150" height="60" rx="0" class="moduleBox"/>
              <text id="svgT-dosing1" x="485" y="185" text-anchor="middle" class="moduleTitle">Gas-Sorbent</text>
              <text id="svgT-dosing2" x="485" y="203" text-anchor="middle" class="moduleSub">(Dosing)</text>
            </g>

            <!-- Horizontal line from Intake to Gas-Sorbent -->
            <path d="M 260 150 L 350 150 L 350 190 L 410 190" class="stream" marker-end="url(#arrow)"/>

            <!-- Line from Gas-Sorbent to Sorption -->
            <path d="M 560 190 L 650 190 L 650 130 L 695 130" class="stream" marker-end="url(#arrow)"/>

            <!-- SORPTION (right side, top row) -->
            <g id="m-sorption" class="module core">
              <rect x="695" y="50" width="90" height="150" rx="0" class="moduleBox"/>
              <text id="svgT-sorption1" x="740" y="120" text-anchor="middle" class="moduleTitle">Sorption</text>
              <text id="svgT-sorption2" x="740" y="138" text-anchor="middle" class="moduleSub">(Contactor)</text>
            </g>

            <!-- Line from Sorption down and left to Separation -->
            <path d="M 785 130 L 805 130 L 805 320 L 580 320" class="stream" marker-end="url(#arrow)"/>

            <!-- SEPARATION (center, middle row) -->
            <g id="m-separation" class="module core">
              <rect x="450" y="290" width="130" height="60" rx="0" class="moduleBox"/>
              <text id="svgT-sep1" x="515" y="315" text-anchor="middle" class="moduleTitle">Separation</text>
              <text id="svgT-sep2" x="515" y="333" text-anchor="middle" class="moduleSub">(Phase split)</text>
            </g>

            <!-- Line from Separation left to Concentrate -->
            <path d="M 515 290 L 515 280 L 240 280 L 240 335 L 220 335" class="stream concentrate" marker-end="url(#arrowConc)"/>

            <!-- CONCENTRATE (lower left) -->
            <g id="m-concentrate">
              <text id="svgT-conc1" x="90" y="320" text-anchor="middle" class="svgLabel" style="fill:rgba(210,132,55,.9);">Concentrate / residual stream</text>
              <text id="svgT-conc2" x="90" y="335" text-anchor="middle" class="svgSubLabel" style="fill:rgba(210,132,55,.75);">(typically &lt;5% of flow;</text>
              <text id="svgT-conc3" x="90" y="348" text-anchor="middle" class="svgSubLabel" style="fill:rgba(210,132,55,.75);">controlled output)</text>
            </g>

            <!-- Line from Separation down to Mineralization -->
            <path d="M 450 320 L 420 320 L 420 450 L 490 450" class="stream" marker-end="url(#arrow)"/>

            <!-- MINERALIZATION (center bottom) -->
            <g id="m-polishing" class="module cots">
              <rect x="490" y="420" width="200" height="60" rx="0" class="moduleBox"/>
              <text id="svgT-min1" x="590" y="448" text-anchor="middle" class="moduleTitle">Mineralization</text>
              <text id="svgT-min2" x="590" y="466" text-anchor="middle" class="moduleTitle">& Polishing</text>
            </g>

            <!-- Line from Mineralization right to DRINKING -->
            <path d="M 690 450 L 750 450 L 750 560" class="stream" marker-end="url(#arrow)"/>

            <!-- DRINKING WATER (bottom right corner) -->
            <g id="m-drinking">
              <text id="svgT-drink1" x="750" y="580" text-anchor="middle" class="svgLabel">Drinking</text>
              <text id="svgT-drink2" x="750" y="598" text-anchor="middle" class="svgLabel">Water</text>
            </g>

            <!-- Core boundary -->
            <path d="M 330 80 L 680 80 L 680 40 L 820 40 L 820 365 L 330 365 Z" class="coreBoundary"/>

            <!-- LEGEND (inside SVG, bottom left) -->
            <g class="legend-group" transform="translate(-30, 450)">
              <text x="0" y="0" class="svgLabel" style="font-weight:700;font-size:10px;letter-spacing:0.08em;">LEGEND</text>
              <rect x="0" y="10" width="14" height="14" rx="0" fill="#D4F1F6" stroke="rgba(0,158,186,0.7)" stroke-width="1.5"/>
              <text x="20" y="21" style="font:400 10px ui-sans-serif,system-ui;fill:rgba(15,23,42,0.75);">AQUINTAQA core module boundary (encapsulated/protected)</text>
              <rect x="0" y="30" width="14" height="14" rx="0" fill="#fff" stroke="rgba(186,198,211,0.8)" stroke-width="1.5"/>
              <text x="20" y="41" style="font:400 10px ui-sans-serif,system-ui;fill:rgba(15,23,42,0.75);">COTS-based auxiliary systems (intake, utilities, polishing, controls)</text>
              <text x="0" y="60" style="font:italic 400 9px ui-sans-serif,system-ui;fill:rgba(100,116,139,0.8);">Note: sensitive setpoints, materials, and core control logic are disclosed stepwise under NDA.</text>
              <text x="0" y="74" style="font:italic 400 9px ui-sans-serif,system-ui;fill:rgba(100,116,139,0.8);">Colour coding applies to modules only, not to streams.</text>
            </g>
          </svg>
        </div>

      </div>
    </div>

    <!-- Interactive panel -->
    <div class="hiw__panel">
      <div class="hiw__panel-header">
        <div class="hiw__detail-kicker" id="detailKicker">STAGE 1</div>
        <h3 class="hiw__detail-title" id="detailTitle">INTAKE & STABILIZATION</h3>
      </div>
      <div class="hiw__panel-body">
        <p class="hiw__detail-text" id="detailText">Seawater or brackish water intake with coarse debris protection and flow stabilization. No heavy pre-treatment required.</p>
      </div>
    </div>

  </div>
</section>

<script>
(function() {
  /* ── Bilingual data ── */
  var stages = [
    {
      id: 'intake',
      name:   { en: 'Intake<br>&\u00a0Stabilization', ru: 'Подача воды' },
      kicker: { en: 'STAGE 1', ru: 'ЭТАП 1' },
      title:  { en: 'INTAKE & STABILIZATION', ru: 'ПОДАЧА ВОДЫ' },
      detail: {
        en: 'Intake of seawater / brackish water. Coarse protection against debris, flow stabilisation and optional baseline pH/oxygen conditioning.<br>No heavy pre-treatment trains.',
        ru: 'Забор морской / солёной воды. Грубая защита от мусора, стабилизация потока и при необходимости базовая коррекция pH/кислорода. Без сложной предочистки.'
      }
    },
    {
      id: 'dosing',
      name:   { en: 'Gas-Sorbent', ru: 'Газо-сорбент' },
      kicker: { en: 'STAGE 2', ru: 'ЭТАП 2' },
      title:  { en: 'GAS-SORBENT (DOSING)', ru: 'ГАЗО-СОРБЕНТ (ДОЗИРОВАНИЕ)' },
      detail: {
        en: 'An inert carrier gas with a fine-dispersed proprietary sorbent is dosed into the flow. Active capture centres are formed<br>and the solution is prepared for selective extraction of salts and impurities.',
        ru: 'В поток дозируется инертный газ-носитель с тонкодисперсным сорбентом запатентованного состава. Формируются активные центры захвата, раствор подготавливается к селективному извлечению солей и примесей.'
      }
    },
    {
      id: 'sorption',
      name:   { en: 'Sorption', ru: 'Контакт' },
      kicker: { en: 'STAGE 3', ru: 'ЭТАП 3' },
      title:  { en: 'SORPTION (CONTACTOR)', ru: 'КОНТАКТ (КОНТАКТОР)' },
      detail: {
        en: 'Intensive mass transfer: salt ions, hardness and dissolved organics are bound to the sorbent surface.<br>The process runs under mild conditions — no membranes, no high pressures, no boiling.',
        ru: 'Интенсивный массообмен: ионы солей, жёсткость и растворённые органики связываются на поверхности сорбента. Процесс идёт при мягких условиях — без мембран, высоких давлений и нагрева.'
      }
    },
    {
      id: 'separation',
      name:   { en: 'Separation', ru: 'Разделение' },
      kicker: { en: 'STAGE 4', ru: 'ЭТАП 4' },
      title:  { en: 'SEPARATION (PHASE SPLIT)', ru: 'РАЗДЕЛЕНИЕ (РАЗДЕЛЕНИЕ ФАЗ)' },
      detail: {
        en: 'Fast phase separation: purified water is separated from the loaded sorbent by mechanical/physical means. No reverse<br>osmosis or distillation. The treated stream goes to final polishing.',
        ru: 'Быстрое разделение фаз: очищенная вода отделяется от нагруженного сорбента механико-физическим способом. Никакого обратного осмоса или выпаривания. Очищенный поток направляется на финальную доводку.'
      }
    },
    {
      id: 'polishing',
      name:   { en: 'Mineralization<br>& Polishing', ru: 'Минерализация' },
      kicker: { en: 'STAGE 5', ru: 'ЭТАП 5' },
      title:  { en: 'MINERALIZATION & POLISHING', ru: 'МИНЕРАЛИЗАЦИЯ И ДОВОДКА' },
      detail: {
        en: 'Final tuning: precise remineralisation to a drinking profile (TDS ~100–150 mg/L), Ca/Mg balance, pH 7.2–7.8, disinfection<br>(UV/ozone on demand). At the outlet — ready-to-drink water.',
        ru: 'Финальная доводка: тонкая минерализация до питьевого профиля (TDS ~100–150 мг/л), баланс Ca/Mg, pH 7,2–7,8, обеззараживание (UV/озон по требованию). На выходе — готовая питьевая вода.'
      }
    }
  ];

  /* SVG text translations */
  var svgT = {
    'svgT-feed1':    { en: 'Feed water',               ru: 'Подача воды' },
    'svgT-feed2':    { en: '(seawater / brackish /',   ru: '(морская / солоноватая /' },
    'svgT-feed3':    { en: 'high-salinity / variable)',ru: 'высокосолёная / переменная)' },
    'svgT-intake1':  { en: 'Intake',                   ru: 'Подача' },
    'svgT-intake2':  { en: '& Stabilization',          ru: 'воды' },
    'svgT-gas1':     { en: 'Inert carrier gas',        ru: 'Инертный газ-носитель' },
    'svgT-gas2':     { en: '+ proprietary sorbent',    ru: '+ запатентованный сорбент' },
    'svgT-dosing1':  { en: 'Gas-Sorbent',              ru: 'Газо-сорбент' },
    'svgT-dosing2':  { en: '(Dosing)',                 ru: '(Дозирование)' },
    'svgT-sorption1':{ en: 'Sorption',                 ru: 'Контакт' },
    'svgT-sorption2':{ en: '(Contactor)',              ru: '(Контактор)' },
    'svgT-sep1':     { en: 'Separation',               ru: 'Разделение' },
    'svgT-sep2':     { en: '(Phase split)',             ru: '(Разделение фаз)' },
    'svgT-conc1':    { en: 'Concentrate / residual stream', ru: 'Концентрат / остаточный поток' },
    'svgT-conc2':    { en: '(typically <5% of flow;',  ru: '(обычно <5% потока;' },
    'svgT-conc3':    { en: 'controlled output)',        ru: 'контролируемый сброс)' },
    'svgT-min1':     { en: 'Mineralization',            ru: 'Минерализация' },
    'svgT-min2':     { en: '& Polishing',               ru: 'и доводка' },
    'svgT-drink1':   { en: 'Drinking',                  ru: 'Питьевая' },
    'svgT-drink2':   { en: 'Water',                     ru: 'вода' }
  };

  var moduleMap = {
    'intake':     document.getElementById('m-intake'),
    'dosing':     document.getElementById('m-dosing'),
    'sorption':   document.getElementById('m-sorption'),
    'separation': document.getElementById('m-separation'),
    'polishing':  document.getElementById('m-polishing')
  };

  var sideBtns    = document.querySelectorAll('.hiw__stage-btn');
  var detailKicker = document.getElementById('detailKicker');
  var detailTitle  = document.getElementById('detailTitle');
  var detailText   = document.getElementById('detailText');
  var pageTitle    = document.querySelector('.hiw__title');

  var currentStage = 0;
  var currentLang  = 'en';

  function setActiveStage(index) {
    currentStage = index;
    var stage = stages[index];
    var l = currentLang;

    sideBtns.forEach(function(b, i) { b.classList.toggle('is-active', i === index); });

    Object.values(moduleMap).forEach(function(m) { if (m) m.classList.remove('is-active'); });
    if (moduleMap[stage.id]) moduleMap[stage.id].classList.add('is-active');

    detailKicker.textContent = stage.kicker[l];
    detailTitle.textContent  = stage.title[l];
    detailText.innerHTML     = stage.detail[l];
  }

  function applyLang(l) {
    currentLang = l;

    /* Page title */
    if (pageTitle) pageTitle.textContent = (l === 'ru') ? 'КАК ЭТО РАБОТАЕТ' : 'HOW IT WORKS';

    /* Update lang switcher buttons */
    document.querySelectorAll('.lang-btn-hiw').forEach(function(btn) {
      btn.classList.toggle('active', btn.getAttribute('data-lang') === l);
    });

    /* Stage button names */
    sideBtns.forEach(function(btn, i) {
      var nameEl = btn.querySelector('.hiw__stage-name');
      if (nameEl) nameEl.innerHTML = stages[i].name[l];
    });

    /* SVG text */
    Object.keys(svgT).forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.textContent = svgT[id][l];
    });

    /* Refresh detail panel */
    setActiveStage(currentStage);
  }

  sideBtns.forEach(function(btn, i) {
    btn.addEventListener('click', function() { setActiveStage(i); });
  });

  /* Expose globally so onclick="window.setLang()" buttons work */
  window.setLang = applyLang;

  /* Listen for language change from parent */
  window.addEventListener('message', function(e) {
    if (e.data && e.data.type === 'setLang') applyLang(e.data.lang);
  });

  /* Init: read localStorage (same-origin) */
  var saved = 'en';
  try { saved = localStorage.getItem('ui_lang') || 'en'; } catch(e) {}
  applyLang(saved);
})();
</script>

<!-- MOBILE ONLY: pan / zoom for the diagram ──────────────────── -->
<script>
(function () {
  if (!window.matchMedia('(max-width: 767px)').matches) return;

  var wrapper = document.querySelector('.hiw__diagram-wrapper');
  var svg    = document.querySelector('.hiw__svg');
  if (!wrapper || !svg) return;

  /* ── Build DOM ── */
  var vp    = document.createElement('div');  vp.className    = 'hiw-mobile-vp';
  var inner = document.createElement('div');  inner.className = 'hiw-mobile-inner';
  inner.appendChild(svg);
  vp.appendChild(inner);

  /* zoom buttons */
  var bar = document.createElement('div');
  bar.className = 'hiw-zoom-bar';
  bar.innerHTML =
    '<button class="hiw-zoom-btn" id="hiwZoomIn"  aria-label="Zoom in">+</button>' +
    '<button class="hiw-zoom-btn" id="hiwZoomOut" aria-label="Zoom out">&#8722;</button>';
  vp.appendChild(bar);

  /* hint */
  var hint = document.createElement('div');
  hint.className = 'hiw-mobile-hint';
  hint.textContent = 'drag to pan · pinch to zoom · double-tap to reset';

  wrapper.innerHTML = '';
  wrapper.appendChild(vp);
  wrapper.appendChild(hint);

  /* ── State ── */
  var scale = 1, tx = 0, ty = 0;
  var SVG_W = 900, SVG_H = 620;

  function applyT() {
    inner.style.transform =
      'translate(' + tx + 'px,' + ty + 'px) scale(' + scale + ')';
  }

  function clamp(v, lo, hi) { return Math.min(Math.max(v, lo), hi); }

  function clampPan() {
    var vpW = vp.clientWidth, vpH = vp.clientHeight;
    var sw  = SVG_W * scale,  sh  = SVG_H * scale;
    var ox  = Math.max(sw * 0.25, 40);
    var oy  = Math.max(sh * 0.25, 30);
    tx = clamp(tx, vpW - sw - ox,  ox);
    ty = clamp(ty, vpH - sh - oy,  oy);
  }

  /* initial transform: fit diagram width into viewport, centre vertically */
  function initT() {
    var vpW = vp.clientWidth, vpH = vp.clientHeight;
    scale = vpW / SVG_W;
    var sh = SVG_H * scale;
    tx = 0;
    ty = sh < vpH ? (vpH - sh) / 2 : 0;
    applyT();
  }

  /* zoom toward a point (cx, cy) in viewport-local coords */
  function zoomAt(cx, cy, factor) {
    var ns = clamp(scale * factor, 0.3, 3.5);
    tx = cx - (cx - tx) * (ns / scale);
    ty = cy - (cy - ty) * (ns / scale);
    scale = ns;
    clampPan();
    applyT();
  }

  /* ── Pointer events (covers mouse + touch via Pointer API) ── */
  var ptrs = {};          /* pointerId → {x,y} */
  var lastDist = 0;
  var lastPX = 0, lastPY = 0;

  vp.addEventListener('pointerdown', function (e) {
    vp.setPointerCapture(e.pointerId);
    ptrs[e.pointerId] = { x: e.clientX, y: e.clientY };
    lastPX = e.clientX; lastPY = e.clientY;
    lastDist = 0;
    vp.classList.add('is-grabbing');
    e.preventDefault();
  });

  vp.addEventListener('pointermove', function (e) {
    if (!ptrs[e.pointerId]) return;
    ptrs[e.pointerId] = { x: e.clientX, y: e.clientY };

    var ids = Object.keys(ptrs);

    if (ids.length === 2) {
      /* ── pinch ── */
      var a = ptrs[ids[0]], b = ptrs[ids[1]];
      var dx = b.x - a.x, dy = b.y - a.y;
      var dist = Math.sqrt(dx * dx + dy * dy);
      if (lastDist > 0 && dist > 0) {
        var cx = (a.x + b.x) / 2 - vp.getBoundingClientRect().left;
        var cy = (a.y + b.y) / 2 - vp.getBoundingClientRect().top;
        zoomAt(cx, cy, dist / lastDist);
      }
      lastDist = dist;
    } else if (ids.length === 1) {
      /* ── pan ── */
      tx += e.clientX - lastPX;
      ty += e.clientY - lastPY;
      clampPan();
      applyT();
    }

    lastPX = e.clientX; lastPY = e.clientY;
    e.preventDefault();
  });

  function ptrUp(e) {
    delete ptrs[e.pointerId];
    lastDist = 0;
    if (Object.keys(ptrs).length === 0) vp.classList.remove('is-grabbing');
    e.preventDefault();
  }
  vp.addEventListener('pointerup',     ptrUp);
  vp.addEventListener('pointercancel', ptrUp);

  /* ── Wheel zoom (desktop / devtools) ── */
  vp.addEventListener('wheel', function (e) {
    e.preventDefault();
    var r  = vp.getBoundingClientRect();
    zoomAt(e.clientX - r.left, e.clientY - r.top, e.deltaY < 0 ? 1.12 : 0.89);
  }, { passive: false });

  /* ── Double-tap → reset ── */
  var lastTap = 0, tapTimer = null;
  vp.addEventListener('pointerup', function (e) {
    if (Object.keys(ptrs).length !== 0) return;
    var now = Date.now();
    if (now - lastTap < 320) {
      clearTimeout(tapTimer);
      initT();
    }
    lastTap = now;
  });

  /* ── + / – buttons ── */
  document.getElementById('hiwZoomIn').addEventListener('click', function (e) {
    e.stopPropagation();
    zoomAt(vp.clientWidth / 2, vp.clientHeight / 2, 1.3);
  });
  document.getElementById('hiwZoomOut').addEventListener('click', function (e) {
    e.stopPropagation();
    zoomAt(vp.clientWidth / 2, vp.clientHeight / 2, 0.77);
  });

  /* prevent native page scroll while inside viewport */
  vp.addEventListener('touchstart', function (e) { e.preventDefault(); }, { passive: false });
  vp.addEventListener('touchmove',  function (e) { e.preventDefault(); }, { passive: false });

  /* ── Init ── */
  setTimeout(initT, 0);               /* wait for layout */
  window.addEventListener('resize', initT);
})();
</script>

</body>
</html>
